services:
  ergo:
    image: ghcr.io/ergochat/ergo:stable
    ports:
      - "6667:6667"   # IRC — remove in production (Caddy proxies /ws)
      - "8097:8097"   # WebSocket — remove in production
    environment:
      # Keep Ergo in sync with .env without editing ircd.yaml
      ERGO__DATASTORE__MYSQL__PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme}
      ERGO__API__BEARER_TOKENS: '["${ERGO_API_TOKEN:?set ERGO_API_TOKEN}"]'
      ERGO__SERVER__WEBSOCKETS__ALLOWED_ORIGINS: '${ERGO_WEBSOCKET_ORIGINS:-["http://localhost","http://127.0.0.1"]}'
    volumes:
      - ./config/ergo/ircd.yaml:/ircd/ircd.yaml
      - ergo-data:/ircd/db
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 6667 || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 3
    restart: unless-stopped

  mysql:
    image: mariadb:11
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme}
      MYSQL_DATABASE: ergo_history
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 5
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:v1.9.11
    ports:
      - "7880:7880"
      - "7881:7881"
      - "50060-50160:50060-50160/udp"
    environment:
      LIVEKIT_CONFIG: |
        port: 7880
        rtc:
          tcp_port: 7881
          port_range_start: 50060
          port_range_end: 50160
          use_external_ip: true
        keys:
          ${LIVEKIT_API_KEY:?set LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET:?set LIVEKIT_API_SECRET}
        logging:
          level: info
        room:
          empty_timeout: 300
          max_participants: 50
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7880 || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3
    restart: unless-stopped

  virc-files:
    build: ./virc-files
    ports:
      - "8080:8080"   # API — remove in production (Caddy proxies /api)
    environment:
      ERGO_API: http://ergo:8089
      ERGO_API_TOKEN: ${ERGO_API_TOKEN:?set ERGO_API_TOKEN}
      LIVEKIT_CLIENT_URL: ${LIVEKIT_CLIENT_URL:-ws://localhost:7880}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:?set LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:?set LIVEKIT_API_SECRET}
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret}
      SERVER_NAME: ${SERVER_NAME:-}
      SERVER_ID: ${SERVER_ID:-}
      ALLOWED_ORIGIN: ${ALLOWED_ORIGIN:-}
      BASE_URL: ${BASE_URL:-}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-}
    volumes:
      - virc-uploads:/app/uploads
      - virc-data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3
    depends_on:
      ergo:
        condition: service_healthy
      mysql:
        condition: service_healthy
    restart: unless-stopped

  caddy:
    image: caddy:2
    ports:
      - "443:443"
      - "80:80"
    environment:
      SITE_ADDRESS: ${SITE_ADDRESS:-:80}
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./virc-client/build:/srv/virc
    depends_on:
      ergo:
        condition: service_healthy
      virc-files:
        condition: service_healthy
    restart: unless-stopped

volumes:
  ergo-data:
  mysql-data:
  virc-uploads:
  virc-data:
